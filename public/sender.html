<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>Send Files</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #uploading div { margin: 8px 0; }
    progress { width: 100%; height: 16px; }
  </style>
</head>
<body>
  <div class="beta-ribbon">BETA</div>
  <h2>Send Files</h2>

  <input type="text" id="senderName" placeholder="Enter your name" readonly />

  <!-- Drag Drop -->
  <div id="drop-zone">Drag & Drop or Click to Select Files</div>
  <input type="file" id="fileInput" multiple style="display: none;" />

  <!-- Uploading animation -->
  <div id="uploading" style="display:none; margin-top:15px;"></div>

  <p id="keyInfo"></p>
  <div id="fileTableContainer"></div>

  <div style="margin-top: 1rem;">
    <button id="clearBtn">Clear</button>
  </div>

  <div id="approveSection" style="margin-top: 2rem;">
    <h3>Pending Receiver Requests</h3>
    <div id="pendingRequests"></div>
  </div>

  <script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('fileInput');
    const senderInput = document.getElementById('senderName');
    const uploadingDiv = document.getElementById('uploading');
    let latestKey = null;

    document.addEventListener("DOMContentLoaded", () => {
      const name = localStorage.getItem('userName');
      if (name) senderInput.value = name;
    });

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleMultipleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', () => {
      handleMultipleFiles(fileInput.files);
    });

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function handleMultipleFiles(fileList) {
      const senderName = senderInput.value.trim();
      if (!senderName) return alert("Please enter your name");

      // hide drag-drop section
      dropZone.style.display = "none";

      document.getElementById('keyInfo').innerHTML = '';
      document.getElementById('fileTableContainer').innerHTML = '';
      uploadingDiv.innerHTML = '';
      uploadingDiv.style.display = "block";

      const formData = new FormData();
      formData.append('senderName', senderName);

      for (const file of fileList) {
        formData.append('files', file);
        const wrapper = document.createElement("div");
        wrapper.innerHTML = `
          <div><b>${file.name}</b> (${formatSize(file.size)})</div>
          <progress id="prog-${file.name}" value="0" max="100"></progress>
        `;
        uploadingDiv.appendChild(wrapper);
      }

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/upload");

      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          document.querySelectorAll("#uploading progress").forEach(p => {
            p.value = percent;
          });
        }
      };

      xhr.onload = function () {
        if (xhr.status === 200) {
          const data = JSON.parse(xhr.responseText);
          latestKey = data.key;

          document.getElementById('keyInfo').innerHTML =
            `Share this key: <b>${data.key}</b>`;

          const totalSize = data.files.reduce((sum, f) => sum + Number(f.size), 0);
          const totalFiles = data.files.length;

          const tableHtml = `
            <table>
              <thead>
                <tr><th colspan="2">Total: ${totalFiles} files, ${formatSize(totalSize)}</th></tr>
                <tr><th>File Name</th><th>Size</th></tr>
              </thead>
              <tbody>
                ${data.files.map(f => `
                  <tr>
                    <td>${f.originalName}</td>
                    <td>${formatSize(f.size)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          document.getElementById('fileTableContainer').innerHTML = tableHtml;

          setTimeout(() => {
            uploadingDiv.style.display = "none";
          }, 1000);

          fetchPendingReceivers();
        } else {
          alert("❌ Upload failed");
          uploadingDiv.style.display = "none";
        }
      };

      xhr.onerror = function () {
        alert("❌ Upload error");
        uploadingDiv.style.display = "none";
      };

      xhr.send(formData);
    }

    document.getElementById('clearBtn').addEventListener('click', () => {
      document.getElementById('keyInfo').innerHTML = '';
      document.getElementById('fileTableContainer').innerHTML = '';
      document.getElementById('pendingRequests').innerHTML = '';
      fileInput.value = null;
      latestKey = null;
      uploadingDiv.style.display = "none";
      // show drag-drop section again
      dropZone.style.display = "block";
    });

    async function fetchPendingReceivers() {
      if (!latestKey) return;

      const res = await fetch('/admin/sessions');
      const sessions = await res.json();
      const session = sessions.find(s => s.key === latestKey);
      if (!session) return;

      const pendingList = session.receiversWaiting || [];
      const approvedList = session.approvedReceivers || [];

      const tableRows = pendingList.map((r, index) => {
        const isApproved = approvedList.includes(r);
        return `
          <tr>
            <td>${index + 1}</td>
            <td><b>${r}</b></td>
            <td>
              ${
                isApproved
                  ? '<button disabled style="background-color: #4CAF50; color: white;">Approved</button>'
                  : `<button onclick="approve('${latestKey}', '${r}')">Approve</button>`
              }
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('pendingRequests').innerHTML = `
        <table border="1" cellpadding="8" cellspacing="0">
          <thead>
            <tr>
              <th>No.</th>
              <th>Receiver Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      `;
    }

    async function approve(key, receiverName) {
      await fetch('/approve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key, receiverName })
      });

      fetchPendingReceivers();
    }

    setInterval(fetchPendingReceivers, 3000);
  </script>
</body>
</html>
