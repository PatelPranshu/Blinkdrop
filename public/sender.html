<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Send Files</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2>Send Files</h2>

  <input type="text" id="senderName" placeholder="Enter your name" readonly />

  <div id="drop-zone">Drag & Drop or Click to Select Files</div>
  <input type="file" id="fileInput" multiple style="display: none;" />

  <p id="keyInfo"></p>
  <div id="fileTableContainer"></div>

  <div style="margin-top: 1rem;">
    <button id="clearBtn">Clear</button>
  </div>

  <div id="approveSection" style="margin-top: 2rem;">
    <h3>Pending Receiver Requests</h3>
    <div id="pendingRequests"></div>
  </div>

  <script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('fileInput');
    const senderInput = document.getElementById('senderName');
    let latestKey = null;

    document.addEventListener("DOMContentLoaded", () => {
      const name = localStorage.getItem('userName');
      if (name) senderInput.value = name;
    });

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleMultipleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', () => {
      handleMultipleFiles(fileInput.files);
    });

    async function handleMultipleFiles(fileList) {
      const senderName = senderInput.value.trim();
      if (!senderName) return alert("Please enter your name");

      const formData = new FormData();
      formData.append('senderName', senderName);
      for (const file of fileList) formData.append('files', file);

      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();
      latestKey = data.key;
      document.getElementById('keyInfo').innerHTML = `Share this key: <b>${data.key}</b>`;

      const tableHtml = `
        <table>
          <thead><tr><th>File Name</th><th>Key</th></tr></thead>
          <tbody>
            ${data.files.map(f => `<tr><td>${f.originalName}</td><td>${data.key}</td></tr>`).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('fileTableContainer').innerHTML = tableHtml;

      fetchPendingReceivers(); // Start polling after upload
    }

    document.getElementById('clearBtn').addEventListener('click', () => {
      document.getElementById('keyInfo').innerHTML = '';
      document.getElementById('fileTableContainer').innerHTML = '';
      document.getElementById('pendingRequests').innerHTML = '';
      fileInput.value = null;
      latestKey = null;
    });

    async function fetchPendingReceivers() {
      if (!latestKey) return;

      const res = await fetch('/admin/sessions');
      const sessions = await res.json();
      const session = sessions.find(s => s.key === latestKey);
      if (!session) return;

      const pendingList = session.receiversWaiting || [];
      const approvedList = session.approvedReceivers || [];

      const tableRows = pendingList.map((r, index) => {
        const isApproved = approvedList.includes(r);
        return `
          <tr>
            <td>${index + 1}</td>
            <td><b>${r}</b></td>
            <td>
              ${
                isApproved
                  ? '<button disabled style="background-color: #4CAF50; color: white;">Approved</button>'
                  : `<button onclick="approve('${latestKey}', '${r}')">Approve</button>`
              }
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('pendingRequests').innerHTML = `
        <table border="1" cellpadding="8" cellspacing="0">
          <thead>
            <tr>
              <th>No.</th>
              <th>Receiver Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      `;
    }

    async function approve(key, receiverName) {
      await fetch('/approve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key, receiverName })
      });

      fetchPendingReceivers(); // refresh UI immediately
    }

    setInterval(fetchPendingReceivers, 3000);
  </script>
</body>
</html>
